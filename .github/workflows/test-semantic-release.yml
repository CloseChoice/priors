name: Test Semantic Release

on:
  push:
    branches:
      - 'feat/**'
      - 'ci/**'
  workflow_dispatch:
    inputs:
      publish_to_testpypi:
        description: 'Publish to TestPyPI?'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write
  checks: write

jobs:
  commitlint:
    name: Validate Commits
    permissions:
      contents: read
      pull-requests: read
    uses: ./.github/workflows/commitlint.yml

  tests:
    name: Run Tests
    permissions:
      contents: read
      pull-requests: write
      checks: write
    uses: ./.github/workflows/tests.yml

  linting:
    name: Run Linting
    permissions:
      checks: write
      contents: write
    uses: ./.github/workflows/linting.yml

  semantic-release:
    name: Semantic Release (Test)
    needs: [commitlint, tests, linting]
    runs-on: ubuntu-latest
    outputs:
      new-release-published: ${{ steps.semantic.outputs.new-release-published }}
      new-release-version: ${{ steps.semantic.outputs.new-release-version }}
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install semantic-release
        run: |
          npm install semantic-release@latest
          npm install @semantic-release/commit-analyzer
          npm install @semantic-release/release-notes-generator
          npm install @semantic-release/git
          npm install @semantic-release/changelog
          npm install @semantic-release/exec

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use the test config directly
          mv .releaserc.test.json .releaserc.json

          # Capture semantic-release output
          OUTPUT=$(npx semantic-release 2>&1 || true)
          echo "$OUTPUT"

          # Check if version files were created
          if [ -f .next-version-python ] && [ -f .next-version-rust ]; then
            PYTHON_VERSION=$(cat .next-version-python)
            RUST_VERSION=$(cat .next-version-rust)
            echo "✅ New versions created:"
            echo "  Python: $PYTHON_VERSION"
            echo "  Rust: $RUST_VERSION"
            echo "new-release-version=$RUST_VERSION" >> $GITHUB_OUTPUT
            echo "new-release-published=true" >> $GITHUB_OUTPUT
          else
            echo "ℹ️ No new version (no releasable commits since last release)"
            echo "new-release-published=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload version files
        if: steps.semantic.outputs.new-release-published == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: version-files-source
          path: |
            .next-version-python
            .next-version-rust

      - name: Debug outputs
        run: |
          echo "new-release-published: ${{ steps.semantic.outputs.new-release-published }}"
          echo "new-release-version: ${{ steps.semantic.outputs.new-release-version }}"

  update-version:
    name: Update Version Files
    needs: semantic-release
    if: needs.semantic-release.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Download version files
        uses: actions/download-artifact@v4
        with:
          name: version-files-source

      - name: Update version in files
        run: |
          # Read the converted versions
          PYTHON_VERSION=$(cat .next-version-python)
          RUST_VERSION=$(cat .next-version-rust)

          echo "Updating Python version to: $PYTHON_VERSION"
          echo "Updating Rust version to: $RUST_VERSION"

          # Update pyproject.toml with PEP 440 format
          sed -i "s/^version = .*/version = \"$PYTHON_VERSION\"/" priors/pyproject.toml

          # Update Cargo.toml with SemVer format
          sed -i "s/^version = .*/version = \"$RUST_VERSION\"/" priors/Cargo.toml

          echo "Updated files:"
          grep "^version" priors/pyproject.toml
          grep "^version" priors/Cargo.toml

      - name: Upload updated files
        uses: actions/upload-artifact@v4
        with:
          name: version-files
          path: |
            priors/pyproject.toml
            priors/Cargo.toml

  build-and-publish:
    name: Build & Publish to TestPyPI
    needs: [semantic-release, update-version]
    if: always() && needs.semantic-release.result == 'success' && needs.update-version.result == 'success'
    uses: ./.github/workflows/test-release.yml
    secrets: inherit
    with:
      version: ${{ needs.semantic-release.outputs.new-release-version }}
      skip_publish: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.publish_to_testpypi != 'true' }}
