# ASV Branch Selector & Comparison Tool

This document explains the custom branch selector and comparison features added to the ASV benchmark dashboard.

## Features

### 1. **Custom Branch Selector** (Option 2)

A JavaScript-based wrapper that provides:
- ðŸ”„ **Branch Dropdown**: Select any benchmarked branch to view its results
- ðŸ“Š **Embedded ASV Dashboard**: Full ASV interface loaded within the selector
- ðŸŽ¨ **Modern UI**: Clean, responsive design with gradient header
- âš¡ **Fast Switching**: Instant branch switching without page reload

**Access at:** `https://closechoice.github.io/priors/branches.html`

### 2. **ASV Compare Reports** (Option 3)

Automated branch comparison using ASV's built-in compare functionality:
- ðŸ“ˆ **Pairwise Comparisons**: All branches compared against each other
- ðŸ’¾ **Pre-generated Reports**: Comparisons run during CI/CD, no waiting
- ðŸ“ **Stored on GitHub Pages**: Access comparison reports anytime
- ðŸ” **Performance Differences**: See which benchmarks regressed or improved

**Access at:** `https://closechoice.github.io/priors/comparisons/`

## How It Works

### Branch Selector

1. **HTML Wrapper** (`asv-branch-selector.html`):
   - Fetches available branches from `index.json`
   - Populates dropdown with all benchmarked branches
   - Loads ASV dashboard in an iframe
   - Provides comparison interface

2. **Workflow Integration**:
   - Copied to `.asv/html/branches.html` during deployment
   - Automatically includes all branches from `asv.conf.json`
   - Updates with each benchmark run

### ASV Compare

1. **Comparison Generation** (in `benchmarks-reusable.yml`):
   ```bash
   asv compare branch1 branch2 > comparisons/branch1_vs_branch2.txt
   ```

2. **Available Comparisons**:
   - `main_vs_improve-speed.txt`
   - `main_vs_ci_benchmarking.txt`
   - `improve-speed_vs_ci_benchmarking.txt`
   - etc.

3. **Integration**:
   - Branch selector automatically fetches comparison reports
   - Displays in formatted text view
   - Fallback to basic comparison if report unavailable

## Usage

### Viewing Branch Benchmarks

1. Go to `https://closechoice.github.io/priors/branches.html`
2. Select a branch from the dropdown
3. View the full ASV dashboard for that branch

### Comparing Branches

1. On the branch selector page, select your main branch
2. Select a comparison branch from "Compare with" dropdown
3. Click "Compare Branches"
4. View the comparison report showing performance differences

### Direct Comparison Access

Access comparison reports directly:
```
https://closechoice.github.io/priors/comparisons/main_vs_improve-speed.txt
```

## Configuration

### Adding More Branches

Edit `asv.conf.json`:
```json
{
  "branches": ["main", "improve-speed", "feat/**", "ci/**"]
}
```

### Customizing Branch Selector

Edit `asv-branch-selector.html`:
- Modify `BRANCHES_CONFIG` array
- Change styling in `<style>` section
- Customize comparison logic in `compareBranches()` function

## Workflow Details

The branch selector and comparisons are generated in `.github/workflows/benchmarks-reusable.yml`:

1. **Step: Add custom branch selector**
   - Copies `asv-branch-selector.html` to `.asv/html/branches.html`
   - Only runs when `deploy_to_pages: true`

2. **Step: Generate branch comparison reports**
   - Extracts branches from `asv.conf.json`
   - Runs `asv compare` for all pairwise combinations
   - Saves reports to `.asv/html/comparisons/`
   - Continues on error (branches may not have overlapping commits)

## Troubleshooting

### Branch Not Showing in Selector

- Ensure the branch has been benchmarked (workflow ran successfully)
- Check that branch is listed in `asv.conf.json`
- Verify `index.json` contains the branch in `params.branch` array

### Comparison Reports Missing

- Branches need overlapping commits for comparison
- Check workflow logs for comparison generation errors
- Verify both branches have benchmark results

### Branch Selector Not Loading

- Ensure `asv-branch-selector.html` exists in repo root
- Check browser console for JavaScript errors
- Verify `index.json` is accessible

## Architecture

```
priors/
â”œâ”€â”€ asv-branch-selector.html          # Branch selector source
â”œâ”€â”€ .asv/
â”‚   â””â”€â”€ html/                          # Generated by ASV
â”‚       â”œâ”€â”€ index.html                 # Standard ASV dashboard
â”‚       â”œâ”€â”€ branches.html              # Custom branch selector (copied)
â”‚       â”œâ”€â”€ comparisons/               # ASV compare reports
â”‚       â”‚   â”œâ”€â”€ main_vs_improve-speed.txt
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ .asv/                      # Results data
â”‚           â””â”€â”€ results/
â””â”€â”€ .github/workflows/
    â””â”€â”€ benchmarks-reusable.yml        # Generates everything
```

## Future Enhancements

- [ ] Visual diff charts for comparisons
- [ ] Export comparison to CSV/JSON
- [ ] Filter benchmarks by name
- [ ] Historical comparison (commit ranges)
- [ ] Performance regression alerts
- [ ] Integration with GitHub PR comments

## Related Documentation

- [ASV Documentation](https://asv.readthedocs.io/)
- [ASV Compare Command](https://asv.readthedocs.io/en/stable/commands.html#asv-compare)
- [CI Integration Guide](./CI_INTEGRATION.md)
